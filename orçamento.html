<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Orçamento Profissional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 3px solid #f5f5f5;
            padding-bottom: 30px;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #333;
            margin-bottom: 10px;
        }
        
        .title-accent {
            color: #ff8c00;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .card {
            background: #ffffff;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #fff8f0, #fff4e6);
            padding: 20px 25px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .card-description {
            color: #666;
            font-size: 0.95rem;
            margin-top: 5px;
        }
        
        .card-content {
            padding: 25px;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            color: #333;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff8c00;
            box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.1);
        }
        
        .logo-upload {
            display: flex;
            align-items: start;
            gap: 20px;
        }
        
        .logo-preview {
            width: 120px;
            height: 120px;
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            background: #fafafa;
        }
        
        .logo-preview:hover {
            border-color: #ff8c00;
            background: #fff8f0;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-placeholder {
            text-align: center;
            color: #888;
            font-size: 0.8rem;
            padding: 10px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff8c00, #ff9500);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #e67c00, #ff8c00);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.25);
        }
        
        .btn-outline {
            background: transparent;
            color: #ff8c00;
            border: 2px solid #ff8c00;
        }
        
        .btn-outline:hover:not(:disabled) {
            background: #ff8c00;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 12px;
            align-items: end;
            padding: 15px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #f0f0f0;
            margin-bottom: 10px;
        }
        
        .item-subtotal {
            background: #f8f8f8 !important;
            color: #666;
            cursor: not-allowed;
        }
        
        .totals-section {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 1.1rem;
        }
        
        .total-row.final {
            border-top: 2px solid #ff8c00;
            padding-top: 15px;
            margin-top: 15px;
            font-size: 1.4rem;
            font-weight: 700;
            color: #ff8c00;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 15px 0;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #ff8c00;
        }
        
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        .pix-fields {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 1px solid #e0e8f0;
        }
        
        .pix-fields.show {
            display: block;
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f5f5f5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .item-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .logo-upload {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Gerador de <span class="title-accent">Orçamento</span></h1>
            <p class="subtitle">Crie orçamentos profissionais facilmente e com pouvos cliques.</p>
        </div>
        
        <!-- Dados da Empresa -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Dados da Sua Empresa</h2>
                <p class="card-description">Informações que aparecerão no cabeçalho do orçamento</p>
            </div>
            <div class="card-content">
                <div class="logo-upload">
                    <div>
                        <div class="form-group">
                            <label>Logo da Empresa</label>
                            <div class="logo-preview" id="logoPreview" onclick="document.getElementById('logoInput').click()">
                                <div class="logo-placeholder">
                                    Clique para<br>adicionar logo
                                </div>
                            </div>
                            <input type="file" id="logoInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="grid grid-2" style="flex: 1;">
                        <div class="form-group full-width">
                            <label for="empresaNome">Nome da Empresa *</label>
                            <input type="text" id="empresaNome" placeholder="Sua Empresa LTDA" required>
                        </div>
                        <div class="form-group">
                            <label for="empresaDoc">CNPJ / CPF</label>
                            <input type="text" id="empresaDoc" placeholder="00.000.000/0001-00">
                        </div>
                        <div class="form-group">
                            <label for="empresaTel">Telefone</label>
                            <input type="tel" id="empresaTel" placeholder="(11) 99999-9999">
                        </div>
                        <div class="form-group full-width">
                            <label for="empresaEmail">Email</label>
                            <input type="email" id="empresaEmail" placeholder="contato@suaempresa.com">
                        </div>
                        <div class="form-group">
                            <label for="empresaCidade">Cidade *</label>
                            <input type="text" id="empresaCidade" placeholder="São Paulo" required>
                        </div>
                        <div class="form-group">
                            <label for="empresaEstado">Estado (UF) *</label>
                            <input type="text" id="empresaEstado" placeholder="SP" maxlength="2" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="empresaEnd">Endereço Completo</label>
                            <input type="text" id="empresaEnd" placeholder="Rua Exemplo, 123, Bairro">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dados do Cliente -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Dados do Cliente</h2>
                <p class="card-description">Informações do destinatário do orçamento</p>
            </div>
            <div class="card-content">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="clienteNome">Nome Completo *</label>
                        <input type="text" id="clienteNome" placeholder="Nome do Cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="clienteEmail">Email</label>
                        <input type="email" id="clienteEmail" placeholder="email@cliente.com">
                    </div>
                    <div class="form-group">
                        <label for="clienteTel">Telefone</label>
                        <input type="tel" id="clienteTel" placeholder="(21) 98888-8888">
                    </div>
                    <div class="form-group">
                        <label for="clienteEnd">Endereço</label>
                        <input type="text" id="clienteEnd" placeholder="Endereço do Cliente (Opcional)">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Itens do Orçamento -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Itens do Orçamento</h2>
                <p class="card-description">Adicione os produtos ou serviços</p>
            </div>
            <div class="card-content">
                <div id="itensContainer"></div>
                <button type="button" class="btn btn-outline" onclick="adicionarItem()">
                    Adicionar Item
                </button>
            </div>
        </div>
        
        <!-- Resumo e Pagamento -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Resumo e Pagamento</h2>
                <p class="card-description">Totais e opções de pagamento</p>
            </div>
            <div class="card-content">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="observacoes">Observações</label>
                        <textarea id="observacoes" rows="6" placeholder="Ex: Condições de pagamento, validade da proposta, etc."></textarea>
                    </div>
                    <div>
                        <div class="totals-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotalValue">R$ 0,00</span>
                            </div>
                            <div class="total-row">
                                <span>Desconto (R$):</span>
                                <input type="number" id="desconto" value="0" step="0.01" style="width: 100px; text-align: right; border: 1px solid #ddd; border-radius: 5px; padding: 5px;">
                            </div>
                            <div class="total-row final">
                                <span>TOTAL:</span>
                                <span id="totalValue">R$ 0,00</span>
                            </div>
                        </div>
                          
                        <div class="pix-fields" id="pixFields">
                            <div class="form-group">
                                <label for="pixChave">Chave PIX *</label>
                                <input type="text" id="pixChave" placeholder="Ex: email@empresa.com, (11) 99999-9999, 123.456.789-10">
                                <small style="color: #666; font-size: 0.85rem; margin-top: 5px;">
                                    Formatos aceitos: Email, Telefone (11) 99999-9999, CPF 000.000.000-00, CNPJ 00.000.000/0001-00 ou chave aleatória
                                </small>
                            </div>
                            <div class="alert alert-warning">
                                <strong>Informação:</strong> O QR Code PIX é gerado seguindo o padrão EMV do Banco Central do Brasil. Certifique-se de usar uma chave PIX válida e ativa.
                            </div>
                            
                            <!-- Botão de teste do PIX -->
                            <button type="button" class="btn btn-outline" onclick="testarPIX()" style="width: 100%; margin-top: 10px;">
                                🔍 Testar Geração do PIX
                            </button>
                            <div id="pixTestResult" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button type="button" class="btn btn-outline" onclick="limparFormulario()">
                Limpar Formulário
            </button>
            <button type="button" class="btn btn-primary" id="gerarPdfBtn" onclick="gerarPDF()">
                Gerar PDF
            </button>
        </div>
    </div>

    <script>
        let logoBase64 = null;
        let itemCounter = 0;
        
        // Formatação de moeda
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        };
        
        // Gerar string PIX EMV completa (padrão Banco Central)
        function generatePixEMV(pixKey, merchantName, merchantCity, amount = null) {
            // Limpar e validar entradas
            pixKey = pixKey.trim();
            merchantName = merchantName.trim().substring(0, 25); // Máximo 25 caracteres
            merchantCity = merchantCity.trim().substring(0, 15); // Máximo 15 caracteres
            
            // Função para criar campo EMV
            function createEMVField(id, value) {
                const valueStr = String(value);
                const length = valueStr.length.toString().padStart(2, '0');
                return id + length + valueStr;
            }
            
            // Campos obrigatórios do EMV PIX
            let emv = '';
            
            // Payload Format Indicator (sempre 01)
            emv += createEMVField('00', '01');
            
            // Merchant Account Information
            let merchantAccountInfo = '';
            merchantAccountInfo += createEMVField('00', 'BR.GOV.BCB.PIX');
            merchantAccountInfo += createEMVField('01', pixKey);
            emv += createEMVField('26', merchantAccountInfo);
            
            // Merchant Category Code (7372 = PIX)
            emv += createEMVField('52', '7372');
            
            // Transaction Currency (986 = BRL)
            emv += createEMVField('53', '986');
            
            // Transaction Amount (se especificado)
            if (amount && amount > 0) {
                const amountStr = amount.toFixed(2);
                emv += createEMVField('54', amountStr);
            }
            
            // Country Code (BR)
            emv += createEMVField('58', 'BR');
            
            // Merchant Name
            emv += createEMVField('59', merchantName);
            
            // Merchant City
            emv += createEMVField('60', merchantCity);
            
            // CRC16 placeholder
            emv += '6304';
            
            // Calcular CRC16 (CCITT)
            function calculateCRC16(data) {
                let crc = 0xFFFF;
                const polynomial = 0x1021;
                
                for (let i = 0; i < data.length; i++) {
                    crc ^= (data.charCodeAt(i) << 8);
                    
                    for (let j = 0; j < 8; j++) {
                        if ((crc & 0x8000) !== 0) {
                            crc = ((crc << 1) ^ polynomial) & 0xFFFF;
                        } else {
                            crc = (crc << 1) & 0xFFFF;
                        }
                    }
                }
                
                return crc.toString(16).toUpperCase().padStart(4, '0');
            }
            
            // Adicionar CRC16 calculado
            const crc = calculateCRC16(emv);
            emv += crc;
            
            return emv;
        }
        
        // Validar tipos de chave PIX (versão mais flexível)
        function validarChavePIX(chave) {
            if (!chave) return { valida: false, tipo: null, chave: null };
            
            chave = chave.trim();
            
            // CPF (com ou sem formatação, aceita espaços)
            const cpfLimpo = chave.replace(/[\s\.\-]/g, '');
            if (/^\d{11}$/.test(cpfLimpo)) {
                return { valida: true, tipo: 'CPF', chave: cpfLimpo };
            }
            
            // CNPJ (com ou sem formatação, aceita espaços)
            const cnpjLimpo = chave.replace(/[\s\.\-\/]/g, '');
            if (/^\d{14}$/.test(cnpjLimpo)) {
                return { valida: true, tipo: 'CNPJ', chave: cnpjLimpo };
            }
            
            // Email (mais flexível)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(chave)) {
                return { valida: true, tipo: 'Email', chave: chave.toLowerCase() };
            }
            
            // Telefone (aceita vários formatos com espaços)
            const telefoneLimpo = chave.replace(/[\s\(\)\-\+]/g, '');
            if (/^(55)?[1-9]\d{10}$/.test(telefoneLimpo)) {
                let numeroFinal = telefoneLimpo;
                if (numeroFinal.startsWith('55')) {
                    numeroFinal = numeroFinal.substring(2);
                }
                return { valida: true, tipo: 'Telefone', chave: `+55${numeroFinal}` };
            }
            
            // Chave aleatória (aceita qualquer string de 32+ caracteres)
            if (chave.length >= 8) {
                return { valida: true, tipo: 'Aleatória', chave: chave };
            }
            
            return { valida: false, tipo: null, chave: null };
        }
        
        // Gerar QR Code PIX com fallback
        async function generatePixQRCode(pixKey, merchantName, merchantCity, amount = null) {
            try {
                // Verificar se QRCode está disponível globalmente
                const QRLib = window.QRCode || window.qrcode || QRCode;
                
                if (!QRLib) {
                    throw new Error('Biblioteca QRCode não está disponível');
                }
                
                // Validar chave PIX
                const validacao = validarChavePIX(pixKey);
                if (!validacao.valida) {
                    throw new Error('Chave PIX inválida');
                }
                
                // Gerar string EMV PIX
                const pixString = generatePixEMV(validacao.chave, merchantName, merchantCity, amount);
                
                if (!pixString || pixString.length < 50) {
                    throw new Error('Erro ao gerar código PIX EMV');
                }
                
                // Tentar gerar QR Code
                const canvas = document.createElement('canvas');
                
                // Usar a função correta dependendo da biblioteca
                if (QRLib.toCanvas) {
                    await QRLib.toCanvas(canvas, pixString, {
                        width: 256,
                        margin: 2,
                        color: { dark: '#000000', light: '#FFFFFF' },
                        errorCorrectionLevel: 'M'
                    });
                } else if (QRLib.toString) {
                    // Fallback para versão diferente
                    const qrString = await QRLib.toString(pixString, {
                        type: 'svg',
                        width: 256,
                        margin: 2
                    });
                    throw new Error('Versão SVG não suportada, use versão canvas');
                } else {
                    throw new Error('Método QRCode não encontrado');
                }
                
                return {
                    qrCodeImage: canvas.toDataURL('image/png'),
                    pixString: pixString,
                    isValid: true,
                    chaveInfo: validacao
                };
                
            } catch (error) {
                console.error('Erro ao gerar QR Code PIX:', error);
                return {
                    qrCodeImage: null,
                    pixString: null,
                    isValid: false,
                    error: error.message
                };
            }
        }
        
        // Adicionar item ao orçamento
        function adicionarItem() {
            itemCounter++;
            const container = document.getElementById('itensContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.id = `item-${itemCounter}`;
            
            itemDiv.innerHTML = `
                <div class="form-group">
                    <label>Descrição</label>
                    <input type="text" class="item-descricao" placeholder="Descrição do produto/serviço" onchange="calcularTotais()">
                </div>
                <div class="form-group" style="width: 80px;">
                    <label>Qtd</label>
                    <input type="number" class="item-quantidade" value="1" min="0" step="0.01" onchange="calcularTotais()">
                </div>
                <div class="form-group" style="width: 120px;">
                    <label>Valor Unit.</label>
                    <input type="number" class="item-valor" placeholder="0,00" step="0.01" onchange="calcularTotais()">
                </div>
                <div class="form-group" style="width: 120px;">
                    <label>Subtotal</label>
                    <input type="text" class="item-subtotal" readonly>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger" onclick="removerItem(${itemCounter})">×</button>
                </div>
            `;
            
            container.appendChild(itemDiv);
            calcularTotais();
        }
        
        // Remover item
        function removerItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.remove();
                calcularTotais();
            }
        }
        
        // Calcular totais
        function calcularTotais() {
            let subtotal = 0;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const quantidade = parseFloat(row.querySelector('.item-quantidade').value) || 0;
                const valor = parseFloat(row.querySelector('.item-valor').value) || 0;
                const itemSubtotal = quantidade * valor;
                
                row.querySelector('.item-subtotal').value = formatCurrency(itemSubtotal);
                subtotal += itemSubtotal;
            });
            
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;
            const total = subtotal - desconto;
            
            document.getElementById('subtotalValue').textContent = formatCurrency(subtotal);
            document.getElementById('totalValue').textContent = formatCurrency(total);
        }
        
        // Gerar PDF
        async function gerarPDF() {
            const btn = document.getElementById('gerarPdfBtn');
            const originalText = btn.innerHTML;
            
            // Validações
            const empresaNome = document.getElementById('empresaNome').value.trim();
            const clienteNome = document.getElementById('clienteNome').value.trim();
            const empresaCidade = document.getElementById('empresaCidade').value.trim();
            const empresaEstado = document.getElementById('empresaEstado').value.trim();
            
            if (!empresaNome || !clienteNome) {
                alert('Nome da empresa e nome do cliente são obrigatórios!');
                return;
            }
            
            const incluirPix = document.getElementById('incluirPix').checked;
            const pixChave = document.getElementById('pixChave').value.trim();
            
            if (incluirPix && (!pixChave || !empresaCidade || !empresaEstado)) {
                alert('Para incluir PIX, preencha: Chave PIX, Cidade e Estado da empresa!');
                return;
            }
            
            // Loading
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Gerando PDF...';
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                let yPosition = 20;
                
                // Header com logo (layout melhorado)
                if (logoBase64) {
                    // Criar imagem temporária para calcular proporções
                    const tempImg = new Image();
                    tempImg.src = logoBase64;
                    
                    // Calcular dimensões mantendo proporção
                    const maxWidth = 35;
                    const maxHeight = 25;
                    const imgRatio = tempImg.width / tempImg.height;
                    
                    let logoWidth, logoHeight;
                    if (imgRatio > maxWidth / maxHeight) {
                        logoWidth = maxWidth;
                        logoHeight = maxWidth / imgRatio;
                    } else {
                        logoHeight = maxHeight;
                        logoWidth = maxHeight * imgRatio;
                    }
                    
                    // Logo à direita, texto à esquerda
                    doc.addImage(logoBase64, 'JPEG', pageWidth - logoWidth - 15, 15, logoWidth, logoHeight);
                    
                    // Dados da empresa à esquerda
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text(empresaNome, 15, 25);
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    
                    let yEmpresa = 32;
                    if (empresaEnd) {
                        doc.text(empresaEnd, 15, yEmpresa);
                        yEmpresa += 6;
                    }
                    if (empresaDoc) {
                        doc.text(`Documento: ${empresaDoc}`, 15, yEmpresa);
                        yEmpresa += 6;
                    }
                    if (empresaTel) {
                        doc.text(`Telefone: ${empresaTel}`, 15, yEmpresa);
                        yEmpresa += 6;
                    }
                    if (empresaEmail) {
                        doc.text(`Email: ${empresaEmail}`, 15, yEmpresa);
                    }
                    
                    yPosition = Math.max(50, yEmpresa + 10);
                } else {
                    // Sem logo - layout normal
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text(empresaNome, 15, 25);
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    
                    if (empresaEnd) doc.text(empresaEnd, 15, 32);
                    if (empresaDoc) doc.text(`Documento: ${empresaDoc}`, 15, 38);
                    if (empresaTel) doc.text(`Telefone: ${empresaTel}`, 15, 44);
                    if (empresaEmail) doc.text(`Email: ${empresaEmail}`, 15, 50);
                    
                    yPosition = 65;
                }
                
                // Título e data
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('ORÇAMENTO', 15, yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth - 60, yPosition);
                
                yPosition += 15;
                
                // Dados do cliente
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('DADOS DO CLIENTE', 15, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const clienteEmail = document.getElementById('clienteEmail').value;
                const clienteTel = document.getElementById('clienteTel').value;
                const clienteEnd = document.getElementById('clienteEnd').value;
                
                doc.text(`Nome: ${clienteNome}`, 15, yPosition);
                if (clienteEmail) doc.text(`Email: ${clienteEmail}`, pageWidth/2, yPosition);
                yPosition += 6;
                if (clienteTel) doc.text(`Telefone: ${clienteTel}`, 15, yPosition);
                if (clienteEnd) doc.text(`Endereço: ${clienteEnd}`, pageWidth/2, yPosition);
                
                yPosition += 15;
                
                // Itens (tabela manual)
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('ITENS DO ORÇAMENTO', 15, yPosition);
                yPosition += 10;
                
                // Cabeçalho da tabela
                doc.setFontSize(9);
                doc.text('Descrição', 15, yPosition);
                doc.text('Qtd', 120, yPosition);
                doc.text('Valor Unit.', 140, yPosition);
                doc.text('Subtotal', 170, yPosition);
                yPosition += 5;
                
                // Linha separadora
                doc.line(15, yPosition, 195, yPosition);
                yPosition += 5;
                
                // Itens
                let subtotal = 0;
                doc.setFont(undefined, 'normal');
                
                document.querySelectorAll('.item-row').forEach(row => {
                    const descricao = row.querySelector('.item-descricao').value;
                    const quantidade = parseFloat(row.querySelector('.item-quantidade').value) || 0;
                    const valor = parseFloat(row.querySelector('.item-valor').value) || 0;
                    const itemSubtotal = quantidade * valor;
                    subtotal += itemSubtotal;
                    
                    if (descricao.trim()) {
                        doc.text(descricao.substring(0, 40), 15, yPosition);
                        doc.text(quantidade.toString(), 120, yPosition);
                        doc.text(formatCurrency(valor), 140, yPosition);
                        doc.text(formatCurrency(itemSubtotal), 170, yPosition);
                        yPosition += 6;
                    }
                });
                
                yPosition += 10;
                
                // Totais
                const desconto = parseFloat(document.getElementById('desconto').value) || 0;
                const total = subtotal - desconto;
                
                const totalsX = 140;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('Subtotal:', totalsX, yPosition);
                doc.text(formatCurrency(subtotal), 170, yPosition);
                yPosition += 8;
                
                if (desconto > 0) {
                    doc.text('Desconto:', totalsX, yPosition);
                    doc.text(formatCurrency(desconto), 170, yPosition);
                    yPosition += 8;
                }
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text('TOTAL:', totalsX, yPosition);
                doc.text(formatCurrency(total), 170, yPosition);
                yPosition += 15;
                
                // Observações
                const observacoes = document.getElementById('observacoes').value.trim();
                if (observacoes) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(12);
                    doc.text('Observações:', 15, yPosition);
                    yPosition += 8;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    const splitObservacoes = doc.splitTextToSize(observacoes, pageWidth - 30);
                    doc.text(splitObservacoes, 15, yPosition);
                    yPosition += splitObservacoes.length * 5 + 10;
                }
                
                // PIX se habilitado
                if (incluirPix && pixChave) {
                    try {
                        // Validar dados PIX antes de gerar
                        if (pixChave.length < 3) {
                            throw new Error('Chave PIX muito curta');
                        }
                        
                        if (empresaNome.length < 3) {
                            throw new Error('Nome da empresa muito curto');
                        }
                        
                        if (empresaCidade.length < 2) {
                            throw new Error('Nome da cidade muito curto');
                        }
                        
                        console.log('Gerando PIX com dados:', {
                            chave: pixChave,
                            nome: empresaNome,
                            cidade: `${empresaCidade}/${empresaEstado}`,
                            valor: total
                        });
                        
                        const pixData = await generatePixQRCode(
                            pixChave,
                            empresaNome,
                            `${empresaCidade}/${empresaEstado}`,
                            total
                        );
                        
                        if (pixData && pixData.isValid && pixData.qrCodeImage && yPosition < pageHeight - 80) {
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(14);
                            doc.text('Pagamento via PIX', 15, yPosition);
                            yPosition += 10;
                            
                            // QR Code
                            doc.addImage(pixData.qrCodeImage, 'PNG', 15, yPosition, 50, 50);
                            
                            // Dados do PIX
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(9);
                            doc.text('Chave PIX:', 75, yPosition + 10);
                            doc.text(pixChave.substring(0, 35), 75, yPosition + 16);
                            
                            doc.text('Valor:', 75, yPosition + 26);
                            doc.text(formatCurrency(total), 75, yPosition + 32);
                            
                            doc.text('PIX Copia e Cola:', 75, yPosition + 42);
                            const splitPixString = doc.splitTextToSize(pixData.pixString, pageWidth - 85);
                            doc.text(splitPixString, 75, yPosition + 48);
                            
                            console.log('PIX gerado com sucesso:', pixData.pixString);
                        } else if (pixData && !pixData.isValid) {
                            console.error('Erro ao gerar PIX:', pixData.error);
                            // Adicionar mensagem de erro no PDF
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(12);
                            doc.text('Erro ao gerar PIX', 15, yPosition);
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(10);
                            doc.text('Verifique os dados informados e tente novamente.', 15, yPosition + 10);
                        }
                        
                    } catch (pixError) {
                        console.error('Erro na geração do PIX:', pixError);
                        // Adicionar mensagem de erro no PDF
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(12);
                        doc.text('Erro ao processar PIX', 15, yPosition);
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        doc.text(`Erro: ${pixError.message}`, 15, yPosition + 10);
                    }
                }
                
                // Rodapé
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.text('Orçamento válido por 30 dias a partir da data de emissão.', 15, pageHeight - 15);
                doc.text(`Gerado em ${new Date().toLocaleString('pt-BR')}`, 15, pageHeight - 10);
                
                // Salvar PDF
                const nomeArquivo = `Orcamento_${clienteNome.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(nomeArquivo);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + error.message);
            } finally {
                // Restaurar botão
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Limpar formulário
        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os campos?')) {
                // Limpar todos os inputs
                document.querySelectorAll('input:not([type="file"]), textarea').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = input.type === 'number' && input.id === 'desconto' ? '0' : '';
                    }
                });
                
                // Limpar logo
                logoBase64 = null;
                document.getElementById('logoPreview').innerHTML = `
                    <div class="logo-placeholder">
                        Clique para<br>adicionar logo
                    </div>
                `;
                
                // Limpar itens
                document.getElementById('itensContainer').innerHTML = '';
                itemCounter = 0;
                
                // Ocultar campos PIX
                document.getElementById('pixFields').classList.remove('show');
                
                // Adicionar um item inicial
                adicionarItem();
                
                // Recalcular totais
                calcularTotais();
            }
        }
        
        // Função para testar geração do PIX
        async function testarPIX() {
            const empresaNome = document.getElementById('empresaNome').value.trim();
            const empresaCidade = document.getElementById('empresaCidade').value.trim();
            const empresaEstado = document.getElementById('empresaEstado').value.trim();
            const pixChave = document.getElementById('pixChave').value.trim();
            const resultDiv = document.getElementById('pixTestResult');
            
            // Validações básicas
            if (!empresaNome || !empresaCidade || !empresaEstado || !pixChave) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fee';
                resultDiv.style.border = '1px solid #fcc';
                resultDiv.style.color = '#c33';
                resultDiv.innerHTML = '<strong>Erro:</strong> Preencha todos os campos obrigatórios (Nome da Empresa, Cidade, Estado e Chave PIX)';
                return;
            }
            
            // Primeiro, validar a chave PIX
            const validacao = validarChavePIX(pixChave);
            if (!validacao.valida) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.border = '1px solid #ffeaa7';
                resultDiv.style.color = '#856404';
                resultDiv.innerHTML = `
                    <strong>Chave PIX Inválida</strong><br>
                    Exemplos de formatos aceitos:<br>
                    • Email: email@empresa.com<br>
                    • CPF: 123.456.789-10 ou 12345678910<br>
                    • CNPJ: 12.345.678/0001-90 ou 12345678000190<br>
                    • Telefone: (11) 99999-9999 ou +5511999999999<br>
                    • Chave aleatória: abc123-def456-ghi789
                `;
                return;
            }
            
            try {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f0f8ff';
                resultDiv.style.border = '1px solid #cce7ff';
                resultDiv.style.color = '#0066cc';
                resultDiv.innerHTML = 'Gerando PIX... aguarde...';
                
                // Tentar gerar o PIX
                const pixData = await generatePixQRCode(
                    pixChave,
                    empresaNome,
                    `${empresaCidade}/${empresaEstado}`,
                    100.00 // Valor de teste
                );
                
                if (pixData && pixData.isValid) {
                    resultDiv.style.background = '#efe';
                    resultDiv.style.border = '1px solid #cfc';
                    resultDiv.style.color = '#363';
                    resultDiv.innerHTML = `
                        <strong>PIX gerado com sucesso!</strong><br>
                        <strong>Tipo:</strong> ${pixData.chaveInfo.tipo}<br>
                        <strong>Chave processada:</strong> ${pixData.chaveInfo.chave}<br>
                        <strong>Código EMV:</strong> ${pixData.pixString.length} caracteres<br>
                        <div style="margin-top: 15px; text-align: center;">
                            <img src="${pixData.qrCodeImage}" style="width: 120px; height: 120px; border: 1px solid #ccc; border-radius: 5px;">
                            <br><small>QR Code de teste (valor: R$ 100,00)</small>
                        </div>
                    `;
                } else {
                    resultDiv.style.background = '#fff3cd';
                    resultDiv.style.border = '1px solid #ffeaa7';
                    resultDiv.style.color = '#856404';
                    resultDiv.innerHTML = `<strong>Erro na geração:</strong> ${pixData?.error || 'Erro desconhecido'}`;
                }
                
            } catch (error) {
                console.error('Erro no teste PIX:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fee';
                resultDiv.style.border = '1px solid #fcc';
                resultDiv.style.color = '#c33';
                resultDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
            }
        }
        
        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
                valor = valor.replace(/^(\d{2})(\d{4})(\d{4})$/, '($1) $2-$3');
                valor = valor.replace(/^(\d{2})(\d{1,5})$/, '($1) $2');
                valor = valor.replace(/^(\d{2})$/, '($1');
            }
            input.value = valor;
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Upload de logo
            document.getElementById('logoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoBase64 = e.target.result;
                        document.getElementById('logoPreview').innerHTML = `<img src="${logoBase64}" alt="Logo">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Toggle PIX fields
            document.getElementById('incluirPix').addEventListener('change', function() {
                const pixFields = document.getElementById('pixFields');
                if (this.checked) {
                    pixFields.classList.add('show');
                } else {
                    pixFields.classList.remove('show');
                }
            });
            
            // Event listener para desconto
            document.getElementById('desconto').addEventListener('input', calcularTotais);
            
            // Máscaras para telefones
            document.getElementById('empresaTel').addEventListener('input', function() {
                aplicarMascaraTelefone(this);
            });
            
            document.getElementById('clienteTel').addEventListener('input', function() {
                aplicarMascaraTelefone(this);
            });
            
            // Máscara para CNPJ/CPF
            document.getElementById('empresaDoc').addEventListener('input', function() {
                let valor = this.value.replace(/\D/g, '');
                if (valor.length <= 11) {
                    // CPF
                    valor = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    valor = valor.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
                    valor = valor.replace(/(\d{3})(\d{3})/, '$1.$2');
                } else {
                    // CNPJ
                    valor = valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                    valor = valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})/, '$1.$2.$3/$4');
                    valor = valor.replace(/(\d{2})(\d{3})(\d{3})/, '$1.$2.$3');
                }
                this.value = valor;
            });
            
            // Inicializar com um item
            adicionarItem();
            calcularTotais();
        });
    </script>
</body>
</html>