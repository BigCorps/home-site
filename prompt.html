<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt Inteligente - InterPag BigCorps ChatGPT</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #ffffff;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .header img {
      height: 32px;
    }
    h2 {
      font-size: 22px;
      color: #333;
      margin: 0;
    }
    input[type="file"], input[type="text"] {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 14px;
    }
    button.primary {
      padding: 12px 20px;
      background-color: #f36e21;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.2s;
    }
    button.primary:hover { background-color: #d65d1a; }
    .chat-response {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 10px;
      margin-top: 20px;
      position: relative;
    }
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f36e21;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .footer {
      margin-top: 26px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    .footer img {
      height: 18px;
      vertical-align: middle;
      margin-left: 6px;
    }
    #loadingSpinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(243,110,33,0.25);
      border-radius: 50%;
      border-top-color: #f36e21;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    textarea#responseText {
      width: 100%;
      height: 380px;
      border: none;
      background: transparent;
      resize: vertical;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }

    /* responsividade simples */
    @media (max-width:600px){
      .container { margin: 20px; padding: 18px;}
      h2 { font-size: 18px; }
      textarea#responseText { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" alt="ChatGPT">
      <h2>Criador de Prompt Automático</h2>
    </div>

    <p><strong>Arquivos aceitos:</strong> PDF, TXT, JPG, PNG e CSV</p>
    <input type="file" id="fileInput" accept=".pdf,.txt,.csv,image/jpeg,image/png" />
    <input type="text" id="userInput" placeholder="Insira seu site (ex: https://www.bigcorps.com.br/contato)" />
    <button class="primary" onclick="sendMessage()">Enviar</button>

    <p id="statusMessage" style="display:none; margin-top:12px;">
      <span id="loadingSpinner"></span>
      Gerando resposta, por favor aguarde...
    </p>

    <div id="response" class="chat-response" style="display:none;">
      <button class="copy-btn" onclick="copyResponse()">Copiar</button>
      <textarea id="responseText" readonly></textarea>
    </div>

    <div class="footer">
      Clique no botão Copiar e cole no Prompt do seu Agente.
      Desenvolvido por <strong>BigCorps</strong> com ChatGPT
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" alt="ChatGPT">
      .
    </div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script>
    // Configura worker do PDF.js
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    }

    let fileText = "";
    let fileProcessed = false;
    let fileName = "";

    async function handleFile(file) {
      fileProcessed = false;
      fileText = "";
      fileName = file.name || "";

      if (file.type === "application/pdf" || fileName.toLowerCase().endsWith('.pdf')) {
        // Processar PDF
        try {
          const reader = new FileReader();
          reader.onload = async function () {
            try {
              const typedarray = new Uint8Array(this.result);
              const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;
              let text = "";
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ") + "\n";
              }
              fileText = text;
              fileProcessed = true;
            } catch (err) {
              console.error("Erro ao processar PDF:", err);
              alert("Erro ao processar o PDF. Tente novamente.");
              fileProcessed = true;
            }
          };
          reader.readAsArrayBuffer(file);
        } catch (err) {
          console.error("Erro ao ler PDF:", err);
          alert("Erro ao ler o arquivo. Tente novamente.");
          fileProcessed = true;
        }
      } else if (file.type.startsWith("text/") || fileName.toLowerCase().endsWith('.txt') || fileName.toLowerCase().endsWith('.csv')) {
        // TXT ou CSV
        const reader = new FileReader();
        reader.onload = function (e) {
          fileText = e.target.result || "";
          fileProcessed = true;
        };
        reader.readAsText(file);
      } else if (file.type.startsWith("image/") || /\.(jpg|jpeg|png)$/i.test(fileName)) {
        // Imagem - só marca que houve upload (não fazemos OCR aqui)
        fileText = "O usuário enviou uma imagem que pode conter uma tabela ou cardápio.";
        fileProcessed = true;
      } else {
        alert("Tipo de arquivo não suportado.");
        fileProcessed = true;
      }
    }

    document.getElementById("fileInput").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        handleFile(file);
      } else {
        fileText = "";
        fileProcessed = false;
        fileName = "";
      }
    });

    function copyResponse() {
      const textarea = document.getElementById("responseText");
      if (!navigator.clipboard) {
        // fallback
        textarea.select();
        document.execCommand("copy");
        showCopyFeedback();
      } else {
        navigator.clipboard.writeText(textarea.value).then(() => {
          showCopyFeedback();
        }).catch(() => {
          textarea.select();
          document.execCommand("copy");
          showCopyFeedback();
        });
      }
    }

    function showCopyFeedback() {
      const btn = document.querySelector(".copy-btn");
      btn.textContent = "Copiado!";
      setTimeout(() => btn.textContent = "Copiar", 2000);
    }

    async function sendMessage() {
      const userInput = document.getElementById("userInput").value.trim();
      const fileInput = document.getElementById("fileInput");

      if (!userInput && (!fileInput.files || !fileInput.files[0])) {
        alert("Por favor, insira uma URL ou anexe um arquivo.");
        return;
      }

      document.getElementById("statusMessage").style.display = "block";
      document.getElementById("response").style.display = "none";
      fileProcessed = fileProcessed || false;

      // Se houver arquivo e ainda não processado, aguarda
      if (fileInput.files[0] && !fileProcessed) {
        await new Promise(resolve => {
          const checkProcessing = setInterval(() => {
            if (fileProcessed) {
              clearInterval(checkProcessing);
              resolve();
            }
          }, 200);
        });
      }

      // Simula requisição / processamento (aqui chamamos diretamente generateResponse)
      setTimeout(() => {
        generateResponse(userInput);
      }, 250); // pequeno delay para UX
    }

    // Detecta tipo de negócio a partir do conteúdo
    function detectBusinessType(siteUrl, fileContent) {
      const content = ((siteUrl || "") + " " + (fileContent || "")).toLowerCase();

      if (/(pizza|restaurante|lanchonete|hamburger|comida|cardápio|prato|bebida|delivery|ifood|pizzaria)/i.test(content)) {
        return "restaurante";
      }

      if (/(loja|produto|venda|compra|estoque|catálogo|catalogo|lojas|ecommerce|e-commerce)/i.test(content)) {
        return "loja";
      }

      if (/(serviço|servicos|consultoria|atendimento|agendamento|serviço|servico)/i.test(content)) {
        return "serviços";
      }

      return "geral";
    }

    // Processa CSV de menu (simples)
    function processMenuCSV(csvContent) {
      if (!csvContent) return null;

      const lines = csvContent.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      if (lines.length <= 1) return null;

      const menuItems = {};
      const prices = new Set();

      // tenta separar por vírgula, sem parse CSV completo (melhorias possíveis)
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        // dividir respeitando aspas simples/duplas é complexo; aqui fazemos split simples
        const columns = line.split(',');
        if (columns.length >= 6) {
          const tipo = (columns[0] || "").trim();
          const categoria = (columns[1] || "").trim() || 'OUTROS';
          const descricao = (columns[3] || "").trim();
          const complemento = (columns[4] || "").trim();
          const preco = (columns[5] || "").trim();
          const status = (columns[7] || "").trim();

          // aceita linha sem status também
          const ativo = (status ? status.toLowerCase().includes('ativo') : true);

          if (ativo && preco && preco !== '"R$0,00"' && descricao && descricao.length > 0) {
            if (!menuItems[categoria]) menuItems[categoria] = [];

            let itemName = descricao.replace(/["*]/g, '');
            if (complemento && complemento !== ' - ' && complemento !== '"-"') {
              let compClean = complemento.replace(/["*]/g, '');
              if (compClean.includes(' - ')) compClean = compClean.split(' - ')[1] || compClean;
              itemName += ` (${compClean})`;
            }

            const priceClean = preco.replace(/["]/g, '');
            prices.add(priceClean);

            const exists = menuItems[categoria].some(it => (it.name || '').toLowerCase() === itemName.toLowerCase());
            if (!exists && itemName.length > 2) {
              menuItems[categoria].push({
                name: itemName,
                price: priceClean,
                type: tipo
              });
            }
          }
        }
      }

      return {
        menuItems,
        prices: Array.from(prices),
        hasStructuredData: Object.keys(menuItems).length > 0
      };
    }

    // Extrai dados gerais (preços e possíveis produtos/linhas)
    function extractGeneralData(content) {
      if (!content) return { prices: [], products: [], hasStructuredData: false };

      const pricePatterns = [/R\$\s*\d+[.,]?\d*/g, /\d+[.,]?\d*\s*reais?/gi];
      let prices = [];
      pricePatterns.forEach(p => {
        const matches = content.match(p);
        if (matches) prices = prices.concat(matches);
      });

      const lines = content.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      // identifica linhas que parecem produtos (tem número/preço ou termo 'produto' ou comprimentos razoáveis)
      const products = lines.filter(line =>
        line.length > 10 && (/\bR\$|\d+[,.]\d{2}|\bproduto\b|\bpreço\b|\bpreco\b/i.test(line) || /[A-Za-z\s]{4,}\s-\s?\d/.test(line))
      );

      // normaliza preços
      const uniquePrices = [...new Set(prices)].slice(0, 20);

      return {
        prices: uniquePrices,
        products: products.slice(0, 15),
        hasStructuredData: uniquePrices.length > 0 || products.length > 0
      };
    }

    // Decide qual extractor usar (CSV ou geral)
    function extractStructuredData(text, filename) {
      if (!text) return { prices: [], products: [], hasStructuredData: false };

      const lowerName = (filename || "").toLowerCase();
      const isCSV = lowerName.endsWith('.csv') || /tipo,categoria,tamanho,descri/i.test(text);

      if (isCSV) {
        const csvResult = processMenuCSV(text);
        if (csvResult) return csvResult;
      }

      return extractGeneralData(text);
    }

    // Gera o prompt com base nos dados
    function generateResponse(userInput) {
      const responseBox = document.getElementById("response");
      const responseText = document.getElementById("responseText");

      const businessType = detectBusinessType(userInput || "", fileText || "");
      const structuredData = extractStructuredData(fileText, fileName);

      let promptBase = `# PROMPT PARA AGENTE IA - ASSISTENTE ESPECIALIZADO

## CONTEXTO DA EMPRESA
Você é um assistente IA especializado que representa uma empresa ${businessType === 'restaurante' ? 'do setor alimentício' : businessType === 'loja' ? 'de varejo/comércio' : 'de serviços'}. `;

      if (userInput) {
        promptBase += `A empresa possui o seguinte site/contato: ${userInput}. `;
      }

      promptBase += `Seu objetivo é ajudar clientes de forma profissional, prestativa e eficiente.

## INSTRUÇÕES GERAIS
1. Sempre seja cordial, profissional e use linguagem adequada ao contexto brasileiro
2. Responda de forma clara e objetiva
3. Quando não souber uma informação específica, seja honesto e ofereça alternativas
4. Mantenha o foco no atendimento ao cliente e vendas (quando apropriado)
5. Use emojis de forma moderada para tornar a conversa mais amigável

`;

      if (businessType === 'restaurante') {
        promptBase += `## INFORMAÇÕES ESPECÍFICAS - RESTAURANTE/ALIMENTAÇÃO
- Você atende clientes interessados em cardápio, preços, delivery, reservas
- Sempre destaque opções populares e promoções quando relevante
- Seja prestativo com informações sobre ingredientes e restrições alimentares
- Promova experiências positivas e fidelização

`;
      } else if (businessType === 'loja') {
        promptBase += `## INFORMAÇÕES ESPECÍFICAS - VAREJO/COMÉRCIO
- Você auxilia clientes com produtos, preços, disponibilidade e compras
- Destaque benefícios dos produtos e diferenciais da empresa
- Seja proativo em sugerir produtos complementares
- Facilite o processo de compra e esclareça dúvidas

`;
      } else {
        promptBase += `## INFORMAÇÕES ESPECÍFICAS - SERVIÇOS
- Você orienta clientes sobre serviços oferecidos, agendamentos e processos
- Seja claro sobre procedimentos, prazos e custos
- Destaque a qualidade e confiabilidade dos serviços
- Facilite o agendamento e contato

`;
      }

      // Adiciona dados estruturados se existirem
      if (structuredData && structuredData.hasStructuredData) {
        promptBase += `## BASE DE CONHECIMENTO DA EMPRESA\n`;

        if (businessType === 'restaurante') {
          promptBase += `### CARDÁPIO COMPLETO\n`;
        } else if (businessType === 'loja') {
          promptBase += `### CATÁLOGO DE PRODUTOS\n`;
        } else {
          promptBase += `### SERVIÇOS OFERECIDOS\n`;
        }

        // Se tiver menuItems (CSV)
        if (structuredData.menuItems && Object.keys(structuredData.menuItems).length > 0) {
          Object.keys(structuredData.menuItems).forEach(categoria => {
            if (categoria && categoria !== 'undefined') {
              promptBase += `\n**${categoria.toUpperCase()}:**\n`;
              structuredData.menuItems[categoria].forEach(item => {
                promptBase += `• ${item.name} - ${item.price}\n`;
              });
            }
          });

          promptBase += `\n**OPÇÕES DE BORDAS DISPONÍVEIS:**\n`;
          promptBase += `• Borda Tradicional - Grátis\n• Borda Catupiry - R$ 10,90\n• Borda Cheddar - R$ 10,90\n• Borda Chocolate - R$ 10,90\n• Borda Cream Cheese - R$ 10,90\n• Vulcão Cheddar - R$ 24,90\n• Vulcão Catupiry - R$ 24,90\n• Vulcão Chocolate - R$ 24,90\n• Vulcão Nutella - R$ 26,90\n\n`;
        } else {
          // Processamento padrão para outros tipos de arquivo
          if (structuredData.products && structuredData.products.length > 0) {
            promptBase += `**Principais itens:**\n`;
            structuredData.products.forEach((product, index) => {
              promptBase += `${index + 1}. ${product}\n`;
            });
            promptBase += `\n`;
          }

          if (structuredData.prices && structuredData.prices.length > 0) {
            promptBase += `**Preços identificados:**\n`;
            const uniquePrices = [...new Set(structuredData.prices)];
            uniquePrices.slice(0, 8).forEach(price => {
              promptBase += `• ${price}\n`;
            });
            promptBase += `\n`;
          }
        }

        promptBase += `*Importante: Use estas informações como base para atendimento. Sempre confirme disponibilidade e preços atuais quando necessário.*\n\n`;
      }

      // Diretrizes e exemplos
      promptBase += `## DIRETRIZES DE ATENDIMENTO
1. **Cumprimente** o cliente de forma calorosa e acolhedora
2. **Identifique** a necessidade específica do cliente
3. **Apresente** informações relevantes de forma clara e organizada
4. **Ofereça** opções adicionais e complementos quando apropriado
5. **Facilite** o próximo passo (pedido, agendamento, contato)
6. **Finalize** com cordialidade e disponibilidade para ajudar

## EXEMPLOS DE ATENDIMENTO
`;

      if (businessType === 'restaurante') {
        promptBase += `**Para consultas de cardápio:**
"Olá! Seja bem-vindo! 😊 Ficaria feliz em ajudar com nosso cardápio! Temos várias opções deliciosas. Você tem alguma preferência específica ou gostaria de conhecer nossos sabores mais populares?"

**Para pedidos:**
"Perfeito! Para o seu pedido, você gostaria de pizza grande ou broto? Temos muitos sabores disponíveis e várias opções de borda especiais!"

**Para delivery:**
"Sim, trabalhamos com delivery! 🍕 Atendemos em toda a região. Posso anotar seu pedido e confirmar o endereço de entrega?"
`;
      } else if (businessType === 'loja') {
        promptBase += `**Para consultas de produtos:**
"Olá! 😊 Temos esse produto disponível! Ele custa R$ X e possui [características]. Gostaria de saber mais detalhes ou tem interesse em outros produtos similares?"

**Para disponibilidade:**
"Vou verificar a disponibilidade para você! 📦 Geralmente mantemos bom estoque. Posso confirmar e até reservar o produto. Tem preferência por alguma especificação?"
`;
      } else {
        promptBase += `**Para consultas de serviços:**
"Olá! Ficaria feliz em ajudar! 😊 Oferecemos [tipo de serviço] com qualidade garantida. Gostaria de saber mais sobre o processo ou agendar uma consulta?"

**Para agendamentos:**
"Perfeito! Posso verificar nossa agenda. Qual seria o melhor dia e horário para você? Preciso também de algumas informações básicas para o agendamento."
`;
      }

      promptBase += `
## REGRAS IMPORTANTES
- ✅ Mantenha sempre tom profissional mas amigável
- ✅ Seja proativo em oferecer ajuda e sugestões
- ✅ Use as informações do cardápio/produtos quando relevante
- ✅ Encaminhe para contato direto quando necessário
- ✅ Sempre confirme dados importantes (endereço, telefone, preferências)
- ❌ Não invente informações que não possui na base de dados
- ❌ Não prometa prazos ou condições sem certeza
- ❌ Não seja insistente demais nas vendas

## INFORMAÇÕES DE CONTATO
- Site: ${userInput || 'Não informado'}
- Atendimento: [Inserir telefone/WhatsApp da empresa]
- Horário: [Inserir horário de funcionamento]

---
*Prompt desenvolvido pela BigCorps para otimização de atendimento empresarial via IA.*
`;

      responseText.value = promptBase;
      responseBox.style.display = "block";
      document.getElementById("statusMessage").style.display = "none";
      window.scrollTo({ top: responseBox.offsetTop - 20, behavior: 'smooth' });
    }
  </script>
</body>
</html>
